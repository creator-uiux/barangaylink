services:
  # BarangayLink PHP Application
  - type: web
    name: barangaylink
    runtime: php
    env: php
    region: singapore
    plan: free
    buildCommand: composer install --no-dev --optimize-autoloader
    startCommand: |
      # Wait for MySQL to be ready (with timeout)
      echo "Waiting for MySQL to be ready..."
      for i in {1..60}; do
        if php -r "
        try {
            \$pdo = new PDO('mysql:host=' . getenv('DB_HOST') . ';port=3306;charset=utf8mb4', getenv('DB_USER'), getenv('DB_PASS'));
            echo 'MySQL is ready' . PHP_EOL;
            exit(0);
        } catch (Exception \$e) {
            echo 'MySQL is unavailable - sleeping' . PHP_EOL;
            exit(1);
        }
        "; then
          break
        fi
        sleep 2
      done
      echo "Proceeding with database initialization (MySQL may still be waking)"
      php init_db.php || echo "Database initialization failed, but proceeding"
      echo "Starting PHP server"
      php -S 0.0.0.0:$PORT -t .
    healthCheckPath: /
    
    envVars:
      # Application Environment
      - key: APP_ENVIRONMENT
        value: production
      
      # Database Configuration (use Render MySQL)
      - key: DB_HOST
        fromDatabase: barangaylink-db
        property: host

      - key: DB_NAME
        fromDatabase: barangaylink-db
        property: database

      - key: DB_USER
        fromDatabase: barangaylink-db
        property: username

      - key: DB_PASS
        fromDatabase: barangaylink-db
        property: password
      
      - key: DB_CHARSET
        value: utf8mb4
      
      # Admin Credentials
      - key: ADMIN_EMAIL
        value: admin@barangaylink.gov.ph
      
      - key: ADMIN_PASSWORD
        sync: false  # This should be set in Render Dashboard as a secret
      
      # Session Configuration
      - key: SESSION_SECURE
        value: 1
      
      # PHP Configuration
      - key: PHP_VERSION
        value: "8.1"
      
      - key: DOCUMENT_ROOT
        value: /opt/render/project/src
    
    # Disk storage for uploaded files
    disk:
      name: barangaylink-storage
      mountPath: /opt/render/project/src/uploads
      sizeGB: 1

  # MySQL Database
  - type: mysql
    name: barangaylink-db
    plan: free
    databaseName: barangaylink_db
    databaseUser: barangaylink_user
    region: singapore
    ipAllowList: []  # Empty means accessible from all Render services
